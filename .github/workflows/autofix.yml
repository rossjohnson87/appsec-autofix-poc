      - name: Create Pull Request (only if changes)
        if: steps.diff.outputs.changed == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ci/autofix
          commit-message: "autofix: apply safe patches for Semgrep findings"
          title: "Autofix: safe patches for Semgrep findings"
          body: |
            Automated fixes for Semgrep findings.
            - Script: .github/scripts/autofix.py
            - Artifacts attached to this run
            - Diff lines: ${{ steps.diff.outputs.diff_lines }}
          labels: ai-autofix
          delete-branch: true

      - name: Write metrics (only if changes)
        if: steps.diff.outputs.changed == 'true'
        run: |
          ts=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          prnum="${{ steps.cpr.outputs.pull-request-number }}"
          url="${{ steps.cpr.outputs.pull-request-url }}"
          echo "{
            \"timestamp\":\"$ts\",
            \"run_id\":\"${{ github.run_id }}\",
            \"commit\":\"${{ github.sha }}\",
            \"diff_lines\":\"${{ steps.diff.outputs.diff_lines }}\",
            \"pr_number\":\"$prnum\",
            \"pr_url\":\"$url\",
            \"branch\":\"ci/autofix\",
            \"kpis\":{
              \"pytest_passed\": true
            }
          }" > autofix-metrics.json

      - name: Upload metrics artifact
        if: steps.diff.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: autofix-metrics
          path: |
            autofix-metrics.json
            semgrep-latest.json
