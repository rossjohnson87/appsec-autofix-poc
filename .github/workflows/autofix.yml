      - name: Run Semgrep (JSON)
        run: |
          semgrep --config ./semgrep_rules --json --output semgrep-latest.json || true

      - name: Apply auto-fixes (SQLi/SSRF/OpenRedirect)
        run: |
          python .github/scripts/autofix.py

      - name: Show git status & diff
        id: diff
        shell: bash
        run: |
          echo "=== git status ==="
          git status --porcelain
          echo "=== changed files ==="
          git diff --name-only || true

          # set 'changed' output if there are modifications
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

          # hard guard: avoid mega-diffs
          LINES=$(git diff --unified=0 | wc -l)
          echo "diff_lines=$LINES" >> $GITHUB_OUTPUT
          echo "Computed diff_lines=$LINES"

          # stage all changes (so create-pull-request sees them)
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
          fi

      - name: Run tests (only if changes)
        if: steps.diff.outputs.changed == 'true'
        run: |
          python -m pytest -q

      - name: Create Pull Request (only if changes)
        if: steps.diff.outputs.changed == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ci/autofix
          commit-message: "autofix: apply safe patches for Semgrep findings"
          title: "Autofix: safe patches for Semgrep findings"
          body: |
            Automated fixes for Semgrep findings.
            - Script: .github/scripts/autofix.py
            - Diff lines: ${{ steps.diff.outputs.diff_lines }}
          labels: ai-autofix
          delete-branch: true

      - name: Write metrics (only if changes)
        if: steps.diff.outputs.changed == 'true'
        shell: bash
        run: |
          ts=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          prnum="${{ steps.cpr.outputs.pull-request-number }}"
          prurl="${{ steps.cpr.outputs.pull-request-url }}"
          # fallbacks if outputs are blank
          if [ -z "$prnum" ]; then prnum="null"; fi
          if [ -z "$prurl" ]; then prurl=""; fi

          cat > autofix-metrics.json <<EOF
          {
            "timestamp":"$ts",
            "run_id":"${{ github.run_id }}",
            "commit":"${{ github.sha }}",
            "diff_lines":"${{ steps.diff.outputs.diff_lines }}",
            "pr_number": $prnum,
            "pr_url":"$prurl",
            "branch":"ci/autofix",
            "kpis":{"pytest_passed": true}
          }
          EOF
          echo "Wrote autofix-metrics.json:"
          cat autofix-metrics.json

      - name: Upload artifacts (only if changes)
        if: steps.diff.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: autofix-run-${{ github.run_id }}
          path: |
            semgrep-latest.json
            autofix-metrics.json
            app/db.py
            app/http_client.py
            app/server.py
          if-no-files-found: warn
